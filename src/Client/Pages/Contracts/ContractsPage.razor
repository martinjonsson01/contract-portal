@page "/contracts"
@using Domain.Contracts
@inject HttpClient _http

<SearchBar OnQueryChange="OnQueryChanged"/>

<RecentlyViewed @ref="_recentlyViewed"/>

<FetchData TData="IEnumerable<Contract>"
           Url="@_fetchContractsUrl"
           Context="contracts">

    @foreach (Contract contract in contracts)
    {
        <ContractCard Contract=@contract OnViewed="OnRecentContractAdded"/>
    }

</FetchData>

@code {
    private RecentlyViewed _recentlyViewed = null!;

    private string _fetchContractsUrl = "api/v1/contracts";

    private void OnRecentContractAdded(Contract viewedContract)
    {
        _recentlyViewed.AddViewedContract(viewedContract);
    }

    private void OnQueryChanged(string query)
    {
        string urlSafeQuery = Uri.EscapeDataString(query);
        _fetchContractsUrl = $"api/v1/contracts?query={urlSafeQuery}";
    }
}

@using Domain.Contracts
@using Newtonsoft.Json
@using System.Net.Http.Headers
@using System.Text.Json
@inject ILogger<AdminPage> _logger
@inject HttpClient _http

<h4>Skapa nytt kontrakt</h4>

<EditForm Model="@_contract" OnSubmit="OnSubmit">
    <br />
    <div class="mb-3">
        <label for="title" class="form-label">Titel</label>
        <InputText id="title" class="form-control" placeholder="Kontraktets namn" @bind-Value="@_contract.Name"/>
    </div>
    <div class="mb-3">
        <label for="description" class="form-label">Beskrivning</label>
        <InputTextArea id="description" class="form-control" placeholder="T.ex. vad erbjudandet innebär" @bind-Value="@_contract.Description"/>
    </div>
    <div class="mb-3">
        <label for="instructions" class="form-label">Hur man nyttjar erbjudandet</label>
        <InputTextArea id="instructions" class="form-control" placeholder="T.ex. vilken webbsida man ska gå in på" @bind-Value="@_contract.Instructions"/>
    </div>
    <div class="mb-3">
        <label for="image" class="form-label">Banderoll till kontrakt</label>
        <InputFile id="image" class="form-control" OnChange="(e=> OnFileChosen(e, _inspirationalContent!))"/>
    </div>
    <div class="mb-3">
        <label for="document" class="form-label">Ytterligare dokument eller bild</label>
        <InputFile id="document" class="form-control" OnChange="(e=> OnFileChosen(e, _supplierLogoContent!))"/>
    </div>
    <br />
    <hr />
    <br />
    <div class="mb-3">
        <label for="instructions" class="form-label">Företagets namn</label>
        <InputTextArea id="instructions" class="form-control" placeholder="T.ex. Prodigo" @bind-Value="@_contract.SupplierName"/>
    </div>
    <div class="mb-3">
        <label for="instructions" class="form-label">Kontaktinformation för företaget</label>
        <InputTextArea id="instructions" class="form-control" placeholder="T.ex. namn, e-mail eller telefonnummer" @bind-Value="@_contract.SupplierContactInfo"/>
    </div>
    <div class="mb-3">
        <label for="image" class="form-label">Företagets logotyp</label>
        <InputFile id="image" class="form-control" OnChange="(e=> OnFileChosen(e, _additionalDocumentContent!))"/>
    </div>


    <button type="submit" class="btn btn-primary">Spara</button>
</EditForm>

@code {

    /// <summary>
    /// Called when a contract has been submitted successfully.
    /// </summary>
    [Parameter]
    public EventCallback<Contract> OnContractUploaded { get; set; } = EventCallback<Contract>.Empty;

    private bool _shouldRender;

    private Contract _contract = CreateEmptyContract();

    private MultipartFormDataContent? _supplierLogoContent = new MultipartFormDataContent();

    private MultipartFormDataContent? _inspirationalContent = new MultipartFormDataContent();

    private MultipartFormDataContent? _additionalDocumentContent = new MultipartFormDataContent();

    private static Contract CreateEmptyContract()
    {
        return new Contract
        {
            Name = string.Empty,
            Description = string.Empty,
            Instructions = string.Empty,
            SupplierLogoImagePath = string.Empty,
            SupplierName = string.Empty,
            SupplierContactInfo = string.Empty,
        };
    }

    /// <inheritdoc />
    protected override bool ShouldRender()
    {
        return _shouldRender;
    }

    private void OnFileChosen(InputFileChangeEventArgs arg, MultipartFormDataContent content)
    {
        _shouldRender = false;

        StreamContent fileContent;

        const long bitsInAKilobyte = 1024;
        const long kilobytesInAMegabyte = 1024;
        const long maxFileSize = bitsInAKilobyte * kilobytesInAMegabyte * 100;

        try
        {
            fileContent = new StreamContent(arg.File.OpenReadStream(maxFileSize));
        }
        catch (IOException ex)
        {
            _logger.LogInformation(
                "{FileName} not uploaded: {Message}",
                arg.File.Name, ex.Message);
            return;
        }

        fileContent.Headers.ContentType =
            new MediaTypeHeaderValue(arg.File.ContentType);

        content.Add(
            fileContent,
            "\"file\"",
            arg.File.Name);

        _shouldRender = true;
    }

    private async Task OnSubmit()
    {
        _contract.SupplierLogoImagePath = await UploadImage(_supplierLogoContent!);

        _contract.InspirationalImagePath = await UploadImage(_inspirationalContent!);

        _contract.AdditionalDocument = await UploadImage(_additionalDocumentContent!);

        await UploadContract();
    }

    private async Task<string> UploadImage(MultipartFormDataContent content)
    {
        if (content is null) return string.Empty;

        try
        {
            Console.WriteLine(JsonConvert.SerializeObject(_contract, Formatting.Indented));

            HttpResponseMessage response = await _http.PostAsync("/api/v1/images", content);

            if (response.IsSuccessStatusCode)
            {
                string imageLocation = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"successfully uploaded {imageLocation}");
                return imageLocation;
            }
            return string.Empty;
        }
        finally
        {
            content.Dispose();
        }
    }

    private async Task UploadContract()
    {
        HttpResponseMessage response = await _http.PostAsJsonAsync("/api/v1/contracts/new/contract", _contract);
        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("successfully uploaded!");
            await OnContractUploaded.InvokeAsync(_contract);
            _contract = CreateEmptyContract();
        }
    }

}
